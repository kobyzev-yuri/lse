# Таймзоны в системе

## Хранение в БД (PostgreSQL)

В таблице **trade_history** метки времени `ts` хранятся в **московском времени** (или в иной таймзоне сервера). Чтобы не путаться при отображении и при работе с биржей, в таблицу добавлена колонка **ts_timezone** (VARCHAR, по умолчанию `'Europe/Moscow'`): в ней явно указана таймзона каждой метки. При добавлении сделок (execution_agent, game_5m) в INSERT передаётся `ts_timezone = 'Europe/Moscow'`. Миграция в `init_db.py` добавляет колонку и проставляет `'Europe/Moscow'` для существующих строк с NULL.

## Отображение в интерфейсе

Во всех веб-страницах и API время отображается в **Eastern Time (ET)**:

- Страница **Мониторинг** (`/monitor`): подпись «Обновлено в HH:MM:SS ET» и текст «Время отображается в Eastern Time (ET)».
- API `/api/dashboard`: поле `updated_at` в формате ISO с offset ET, в ответе добавлено поле `timezone: "America/New_York"`.
- Дашборд (текст для Telegram и веба): в заголовке время с суффиксом «ET».
- Форматирование дат в веб-интерфейсе (`_format_ts` в `web_app.py`): к времени добавляется подпись « ET».

При чтении сделок для графика и для списка «Последние сделки» используется сохранённая **ts_timezone**: функция `trade_ts_to_et(ts, source_tz=...)` переводит метку в **ET** для отображения. Таким образом, в БД остаётся явная таймзона метки, а конвертация в ET выполняется только под отображение и логику биржи.
