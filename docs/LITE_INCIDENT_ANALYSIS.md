# Анализ сбоя по LITE: мгновенный вход и закрытие с убытком

## Факты

- **Дата:** 27.02.2026
- Две сделки LITE с **одинаковым временем открытия и закрытия (21:17 MSK)** и крупным минусом:
  - Long 334.69 → 315.20, −19.49 пипсов, −565.17 USD
  - Long 372.09 → 323.38, −48.71 пипсов, −1266.54 USD
- Контекст: LITE ненадолго добавляли в `TICKERS_FAST=SNDK,MU`, затем убрали, но произошла мгновенная покупка и одновременное закрытие с потерей.

---

## 1. Причины «мгновенного» закрытия

Цепочка в коде: `send_sndk_signal_cron.py` → `process_ticker()` → `get_decision_5m()` → `get_open_position()` → `should_close_position()` → `close_position()`.

### 1.1 Стоп-лосс по минимуму последних баров (`bar_low`)

В `game_5m.should_close_position()` стоп проверяется так:

- **Цена для стопа:** `price_for_stop = min(current_price, bar_low)`, где `bar_low` — минимум Low по **последним 6 свечам 5m** (~30 мин) из `get_decision_5m()` (`recent_bars_low_min`).
- Условие закрытия: `pnl_stop_pct = (price_for_stop - entry_price) / entry_price * 100` и если `pnl_stop_pct <= -stop_pct` (по умолчанию −2.5%) → **STOP_LOSS**.

Сценарий:

1. Запуск N: по LITE приходит BUY, цена (close последней свечи) например 334.69 → `record_entry(334.69)` — **открытие в 21:17**.
2. В тех же 5m-данных минимум по последним барам (`recent_bars_low_min`) мог быть уже около 315 (сильная просадка внутри/между свечами).
3. Запуск N+1 (через 5 мин или в ту же минуту при частом кроне): есть открытая позиция, `get_decision_5m()` снова отдаёт тот же или обновлённый `bar_low` ~315. Тогда `price_for_stop ≈ 315`, `pnl_stop_pct ≈ (315−334.69)/334.69*100 ≈ −5.9%`, что хуже −2.5% → **сразу закрытие по STOP_LOSS** по цене close (например 315.20) → **закрытие в 21:17 (или 21:20)**.

Итог: «мгновенное» закрытие — это не баг по времени, а срабатывание стопа по **уже достигнутому минимуму** последних 30 минут. Вход зафиксирован по **close** свечи, а стоп проверяется по **low** тех же свечей, поэтому позиция может закрыться на следующем же запуске крона.

### 1.2 Закрытие по сигналу SELL

В `should_close_position()` также: если `current_decision == "SELL"` → закрытие с типом **SELL**. В `recommend_5m` SELL выставляется при RSI(5m) ≥ 76 (перекупленность). Если на следующем запуске решение по LITE сменилось на SELL, позиция закрылась бы по этому правилу — без влияния стопа.

### 1.3 Две сделки с разными ценами входа в одну минуту

Два входа (334.69 и 372.09) в одну минуту возможны только если **два раза** выполнился вход при **отсутствии** открытой позиции:

- **Параллельные запуски крона** (два процесса за одну минуту): оба увидели «нет позиции», оба получили BUY (цены могли различаться из‑за разного времени запроса 5m), оба вызвали `record_entry` → два BUY в 21:17. Затем один или два следующих запуска закрыли обе позиции по стопу или SELL.
- Либо **ручной запуск** скрипта поверх крона в тот же момент.

Рекомендация: убедиться, что по крону 5m нет дублирования (один инстанс, без перекрывающихся по времени запусков).

---

## 2. Влияние SANDBOX_SLIPPAGE_SELL_PCT=0.3

**Нет влияния на этот инцидент.**

- **SANDBOX_SLIPPAGE_SELL_PCT** используется только в **execution_agent.py** (песочница портфеля): при продаже цена исполнения занижается на заданный процент для консервативной оценки PnL.
- Сделки LITE из отчёта относятся к **игре 5m** (стратегия **GAME_5M**, таблица `trade_history`). Их записывают **game_5m** и **send_sndk_signal_cron**; там конфиг **SANDBOX_SLIPPAGE_SELL_PCT не читается**.
- Вывод: параметр влияет только на расчёт исполнения в песочнице, а не на логику «открыть/закрыть» в игре 5m и не на факт мгновенного закрытия по стопу/SELL.

---

## 3. Рекомендации

1. **Исключить LITE из игры 5m, оставив в TICKERS_FAST для графиков**  
   В `config.env` задать явно:
   ```env
   GAME_5M_TICKERS=SNDK,MU
   ```
   Тогда `send_sndk_signal_cron` будет брать тикеры из `GAME_5M_TICKERS` (см. `ticker_groups.get_tickers_game_5m()`), и LITE не будет обрабатываться на вход/выход, даже если он остаётся в `TICKERS_FAST`.

2. **Проверить крон**  
   Убедиться, что `send_sndk_signal_cron.py` не запускается дважды за одну минуту (один раз в 5 минут — норма).

3. **Опционально: защита от «мгновенного» стопа**  
   В `game_5m.should_close_position()` можно не закрывать по стопу в той же 5m-свече, что и вход (например, не закрывать по STOP_LOSS, если с `entry_ts` прошло меньше 1–2 минут). Это уменьшит срабатывание стопа по «старому» минимуму баров сразу после входа.

4. **SANDBOX_SLIPPAGE_SELL_PCT**  
   Оставлять или менять по необходимости только для песочницы; на логику игры 5m по LITE он не влияет.
