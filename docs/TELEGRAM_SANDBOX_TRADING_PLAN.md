# План: песочница в Telegram, приближенная к игре на бирже

## Цель

Для торговли волатильными активами нужны:
- **Более частое обновление цен** — не раз в день, а в течение сессии
- **Актуальная информация** — последняя цена, время обновления, при необходимости bid/ask
- **Оперативная реакция** — алерты при движении цены, RSI, новостях и срабатывании стоп-лоссов

Ниже — поэтапный план без обязательного перехода на платные real-time провайдеры.

---

## Текущее состояние

| Компонент | Сейчас | Ограничение |
|-----------|--------|-------------|
| Цены | 1 раз в день (cron 22:00 MSK), дневные свечи | Нет внутридневной динамики |
| Источник | yfinance, interval=1d | Бесплатно, дневные данные |
| Портфель | `portfolio_state`, `trade_history` в БД | Нет команд в боте |
| Уведомления | Нет | Нет алертов в Telegram |
| Ставки/спред | Нет | Только close из yfinance |

---

## Фаза 1: Частое обновление цен в сессию (без новых API)

**Идея:** в часы работы бирж обновлять цены чаще, чтобы в боте отображалась «последняя известная» цена и время обновления.

### 1.1 Дополнительный cron для цен в сессию

- **Режим A (простой):** запускать `update_prices.py` не только в 22:00, но и, например, в 12:00, 16:00, 18:00 MSK (пн–пт). Тогда в боте будет видно обновление 3–4 раза за день.
- **Режим B (агрессивный):** каждые 1–2 часа в рабочие часы (09:00–00:00 MSK для учёта NYSE). Лимиты yfinance обычно позволяют такие запросы.

**Реализация:** добавить в `setup_cron.sh` вторую задачу или изменить расписание:

```bash
# Пример: цены каждые 2 часа в сессию (пн-пт)
0 10,12,14,16,18,20,22 * * 1-5 cd $PROJECT_DIR && $PYTHON_PATH scripts/update_prices_cron.py >> logs/cron_update_prices.log 2>&1
```

**В боте:** в ответах `/price` и в анализе показывать «Обновлено: 2026-02-20 18:00» (время последней записи в `quotes` для тикера).

### 1.2 Внутридневные данные (опционально, yfinance)

- yfinance умеет `interval="1h"` при `period` до 60 дней — можно хранить часовые свечи в отдельной таблице `quotes_1h` и использовать их для:
  - графика «внутри дня» в боте (`/chart` за сегодня/вчера по часам);
  - расчёта «текущей» цены как последней часовой закрытия.
- Ограничение: не все тикеры/биржи отдают 1h стабильно, нужна обработка пустых ответов.

**Итог фазы 1:** пользователь видит более свежую цену и время обновления, при желании — часовой график. Без новых ключей и платных API.

---

## Фаза 2: Виртуальная «игра» в боте (портфель + сделки)

**Идея:** в Telegram доступны команды виртуальной торговли и текущий P&L по последним ценам.

### 2.1 Команды в боте

| Команда | Описание |
|---------|----------|
| `/portfolio` или `/status` | Текущий виртуальный портфель: CASH, позиции (тикер, кол-во, средняя цена), оценка по последним ценам из `quotes`, P&L по позициям |
| `/buy <ticker> [qty]` | Виртуальная покупка по последней цене из БД (или по указанной цене для продвинутого варианта) |
| `/sell <ticker> [qty]` | Виртуальная продажа |
| `/history [тикер] [N]` | Последние сделки из `trade_history`; с тикером — только по нему; в ответе — стратегия [GAME_5M / Portfolio / Manual] |

Логику исполнения брать из существующего `execution_agent.py`: проверка лимитов, обновление `portfolio_state` и запись в `trade_history`. Бот вызывает тот же слой, что и веб/крон.

### 2.2 Отображение «текущих ставок» в песочнице

- **Цена:** последняя `close` из `quotes` (или последняя часовая close из `quotes_1h`, если введена фаза 1.2). Подпись: «Цена: $X.XX (обновлено HH:MM)».
- **Bid/Ask:** в бесплатной схеме можно не показывать или позже подключить через Alpaca/Polygon (см. фазу 4). Альтернатива: «ориентир: last» без отдельного bid/ask.

### 2.3 Стоп-лоссы и уведомления по портфелю

- При каждом обновлении цен (cron) или по запросу из бота проверять открытые позиции: если `close` упал на X% от средней цены входа — считать стоп сработанным.
- Действия: записать сделку в `trade_history`, обновить `portfolio_state`, **отправить уведомление в Telegram** («Стоп-лосс по MSFT: -5%»).
- Параметр X задаётся в конфиге (например 5%) и может быть общим или по тикеру позже.

**Итог фазы 2:** песочница становится «игрой»: пользователь открывает/закрывает позиции в боте и получает уведомления о стоп-лоссах. Цены по-прежнему из нашей БД (обновляются по крону).

---

## Фаза 3: Алерты по рынку (движение цены, RSI, новости)

**Идея:** пользователь подписывается на события по тикерам и получает сообщения в Telegram.

### 3.1 Подписки (таблица `telegram_alerts`)

- Поля: `user_id`, `ticker`, `alert_type`, `param`, `created_at`.
- `alert_type`: `price_up`, `price_down`, `rsi_overbought`, `rsi_oversold`, `news`.
- `param`: порог (например 2 для «+2%» или 70 для RSI).

### 3.2 Проверка алертов

- Запуск после каждого обновления цен (в том же cron или отдельным джобом раз в 1–2 часа): для каждого тикера сравнить последнюю цену с предыдущей; вычислить RSI; проверить подписки и отправить сообщения.
- Новости: при добавлении записей в `knowledge_base` (cron новостей) проверять подписки с `alert_type=news` по тикеру и слать «Новая новость по MSFT: заголовок».

### 3.3 Команды в боте

- `/watch <ticker> price +2%` — уведомить при росте на 2%
- `/watch <ticker> rsi 70` — при RSI > 70
- `/watch <ticker> news` — новые новости по тикеру
- `/unwatch <ticker> [type]` — снять подписки
- `/alerts` — список моих подписок

**Итог фазы 3:** оперативная реакция на изменения рынка и новости без необходимости постоянно опрашивать бота.

---

## Фаза 4 (опционально): Ближе к real-time

Если понадобится максимально приблизить игру к реальной торговле:

1. **Источник данных**
   - Alpaca (бесплатный tier с задержкой 15 мин или платный real-time)
   - Polygon.io, Alpha Vantage (премиум) — минутные/real-time
   - Отдельная таблица или кэш «последняя цена» с временем обновления.

2. **Частота обновления**
   - Фоновая задача каждые 1–5 минут обновляет «последнюю цену» по отслеживаемым тикерам и пишет в БД/кэш.
   - В боте: «Цена: $X.XX (15 мин)» или «real-time» в зависимости от источника.

3. **Bid/Ask**
   - Отображать только при наличии данных от провайдера (Alpaca/Polygon и т.д.).

Эту фазу можно отложить и сначала реализовать фазы 1–3: они уже сильно приблизят песочницу к «игре на бирже» при минимальных затратах.

---

## Приоритеты внедрения

| Приоритет | Что делать | Эффект |
|-----------|------------|--------|
| 1 | Фаза 1.1: cron цен 2–4 раза в день в сессию + показ времени обновления в боте | Более актуальная цена в ответах |
| 2 | Фаза 2: команды `/portfolio`, `/buy`, `/sell`, уведомления о стоп-лоссах | Полноценная виртуальная «игра» в боте |
| 3 | Фаза 3: подписки и алерты (цена, RSI, новости) | Оперативная реакция на рынок |
| 4 | Фаза 1.2: часовые данные и график за день (если нужно) | Более детальная картина внутри дня |
| 5 | Фаза 4: real-time / платные API | Максимальное приближение к бирже |

---

## Краткий чеклист для «игры» в телеграм-песочнице

- [ ] Цены обновляются несколько раз в день в часы сессии (фаза 1.1)
- [ ] В ответах бота показывается время последнего обновления цены
- [ ] Команды `/portfolio`, `/buy`, `/sell` и отображение P&L по последним ценам (фаза 2)
- [ ] Уведомления в Telegram о срабатывании стоп-лоссов по виртуальному портфелю (фаза 2)
- [ ] Подписки на алерты: движение цены, RSI, новости (фаза 3)
- [ ] (Опционально) Часовые данные и/или real-time источник (фазы 1.2, 4)

После этого песочница в Telegram будет давать более оперативное обновление цен, информацию о «текущих ставках» (последняя цена + время) и быструю реакцию на изменения рынка и стоп-лоссы.
