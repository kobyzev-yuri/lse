# Пример цепочки сделок в песочнице: изменения в БД

Документ показывает, как меняются таблицы `portfolio_state` и `trade_history` при типичной цепочке действий в Telegram-боте (или при работе торгового цикла).

---

## Исходные константы

- Стартовый кэш: **100 000 USD** (запись `CASH` в `portfolio_state`).
- Комиссия: **0,1%** от объёма сделки (`COMMISSION_RATE = 0.001`).
- Цены берутся из таблицы `quotes` (последняя цена закрытия по тикеру).

---

## Шаг 0: Начальное состояние

**portfolio_state**

| ticker | quantity | avg_entry_price | last_updated        |
|--------|----------|-----------------|---------------------|
| CASH   | 100000   | 0               | 2026-02-20 09:00:00 |

**trade_history** — пусто (или только старые записи).

---

## Шаг 1: Пользователь вводит `/buy SNDK 10`

В `quotes` последняя цена по SNDK: **125.50** USD.

- Объём: 10 × 125.50 = **1 255.00** USD  
- Комиссия: 1 255.00 × 0.001 = **1.26** USD  
- Списывается с кэша: **1 256.26** USD  

**portfolio_state** после сделки:

| ticker | quantity | avg_entry_price | last_updated        |
|--------|----------|-----------------|---------------------|
| CASH   | 98743.74 | 0               | 2026-02-20 10:15:00 |
| SNDK   | 10       | 125.50          | 2026-02-20 10:15:00 |

**trade_history** — добавлена одна строка:

| id | ts                  | ticker | side | quantity | price  | commission | signal_type | total_value | sentiment_at_trade | strategy_name |
|----|---------------------|--------|------|----------|--------|------------|-------------|-------------|--------------------|---------------|
| 1  | 2026-02-20 10:15:00 | SNDK   | BUY  | 10       | 125.50 | 1.26       | MANUAL      | 1256.26     | 0.45               | Manual        |

---

## Шаг 2: Пользователь вводит `/buy GC=F 2`

В `quotes` последняя цена по GC=F (золото): **2650.00** USD.

- Объём: 2 × 2650.00 = **5 300.00** USD  
- Комиссия: 5 300.00 × 0.001 = **5.30** USD  
- Списывается: **5 305.30** USD  

**portfolio_state** после второй сделки:

| ticker | quantity | avg_entry_price | last_updated        |
|--------|----------|-----------------|---------------------|
| CASH   | 93438.44 | 0               | 2026-02-20 11:00:00 |
| SNDK   | 10       | 125.50          | 2026-02-20 10:15:00 |
| GC=F   | 2        | 2650.00         | 2026-02-20 11:00:00 |

**trade_history** — добавлена вторая строка:

| id | ts                  | ticker | side | quantity | price  | commission | signal_type | total_value | sentiment_at_trade | strategy_name |
|----|---------------------|--------|------|----------|--------|------------|-------------|-------------|--------------------|---------------|
| 1  | 2026-02-20 10:15:00 | SNDK   | BUY  | 10       | 125.50 | 1.26       | MANUAL      | 1256.26     | 0.45               | Manual        |
| 2  | 2026-02-20 11:00:00 | GC=F   | BUY  | 2        | 2650.00| 5.30       | MANUAL      | 5305.30     | 0.62               | Manual        |

---

## Шаг 3: Цена SNDK обновилась в `quotes` (cron). Пользователь вводит `/sell SNDK`

В `quotes` новая последняя цена по SNDK: **127.20** USD (рост).

- Продано: 10 шт. по 127.20 = **1 272.00** USD  
- Комиссия: 1 272.00 × 0.001 = **1.27** USD  
- Зачисляется на кэш: **1 270.73** USD  
- P&L по позиции: (127.20 − 125.50) × 10 − 1.26 − 1.27 ≈ **14.20** USD  

Позиция по SNDK закрыта полностью — строка с тикером SNDK в `portfolio_state` **удаляется**.

**portfolio_state** после продажи SNDK:

| ticker | quantity | avg_entry_price | last_updated        |
|--------|----------|-----------------|---------------------|
| CASH   | 94709.17 | 0               | 2026-02-20 16:30:00 |
| GC=F   | 2        | 2650.00         | 2026-02-20 11:00:00 |

**trade_history** — добавлена третья строка (SELL):

| id | ts                  | ticker | side | quantity | price  | commission | signal_type | total_value | sentiment_at_trade | strategy_name |
|----|---------------------|--------|------|----------|--------|------------|-------------|-------------|--------------------|---------------|
| 1  | 2026-02-20 10:15:00 | SNDK   | BUY  | 10       | 125.50 | 1.26       | MANUAL      | 1256.26     | 0.45               | Manual        |
| 2  | 2026-02-20 11:00:00 | GC=F   | BUY  | 2        | 2650.00| 5.30       | MANUAL      | 5305.30     | 0.62               | Manual        |
| 3  | 2026-02-20 16:30:00 | SNDK   | SELL | 10       | 127.20 | 1.27       | MANUAL      | 1270.73     | 0.52               | Manual        |

---

## Шаг 4: Частичная продажа — `/sell GC=F 1`

В `quotes` цена GC=F: **2640.00** USD (небольшое падение).

- Продано: **1** контракт по 2640.00 = **2 640.00** USD  
- Комиссия: 2 640.00 × 0.001 = **2.64** USD  
- Зачисляется: **2 637.36** USD  
- В позиции остаётся: 2 − 1 = **1** контракт; средняя цена входа по оставшейся позиции по-прежнему **2650.00** (не пересчитывается при частичной продаже).  

**portfolio_state** после частичной продажи:

| ticker | quantity | avg_entry_price | last_updated        |
|--------|----------|-----------------|---------------------|
| CASH   | 97346.53 | 0               | 2026-02-20 17:00:00 |
| GC=F   | 1        | 2650.00         | 2026-02-20 17:00:00 |

**trade_history** — добавлена четвёртая строка:

| id | ts                  | ticker | side | quantity | price  | commission | signal_type | total_value | sentiment_at_trade | strategy_name |
|----|---------------------|--------|------|----------|--------|------------|-------------|-------------|--------------------|---------------|
| …  | …                   | …      | …    | …        | …      | …          | …           | …           | …                  | …             |
| 4  | 2026-02-20 17:00:00 | GC=F   | SELL | 1        | 2640.00| 2.64       | MANUAL      | 2637.36     | 0.58               | Manual        |

---

## Шаг 5: Срабатывание стоп-лосса (торговый цикл по крону)

Допустим, по GC=F в `quotes` цена упала до **2517.50** (−5% от 2650.00). При следующем запуске `trading_cycle_cron.py` агент проверяет стоп-лоссы и автоматически закрывает позицию.

- Продано: 1 × 2517.50 = **2 517.50** USD  
- Комиссия: **2.52** USD  
- Зачисляется: **2 514.98** USD  
- В историю пишется **signal_type = 'STOP_LOSS'**, **strategy_name** — из последней сделки BUY по этому тикеру (например, `MomentumStrategy`).  

**portfolio_state** после стоп-лосса:

| ticker | quantity | avg_entry_price | last_updated        |
|--------|----------|-----------------|---------------------|
| CASH   | 99861.51 | 0               | 2026-02-21 09:05:00 |

(Запись GC=F удалена.)

**trade_history** — добавлена строка SELL со стоп-лоссом:

| id | ts                  | ticker | side | quantity | price   | commission | signal_type | total_value | sentiment_at_trade | strategy_name    |
|----|---------------------|--------|------|----------|---------|------------|-------------|-------------|--------------------|------------------|
| …  | …                   | …      | …    | …        | …       | …          | …           | …           | …                  | …                |
| 5  | 2026-02-21 09:05:00 | GC=F   | SELL | 1        | 2517.50 | 2.52       | STOP_LOSS   | 2514.98     | 0.35               | MomentumStrategy |

---

## Сводка по таблицам

| Таблица            | Назначение |
|--------------------|------------|
| **portfolio_state**| Текущий кэш (CASH) и открытые позиции: тикер, количество, средняя цена входа, время обновления. При полном закрытии позиции строка по тикеру удаляется; при частичной продаже обновляется только `quantity`. |
| **trade_history**  | Неизменяемая история сделок: каждая покупка и продажа — одна строка с ценой, объёмом, комиссией, типом сигнала (MANUAL / STOP_LOSS / BUY / SELL) и стратегией. |

Все суммы в примере приведены в USD. Реальные значения в БД зависят от цен в `quotes` на момент исполнения и от настроек комиссии и стоп-лосса в коде и в `local/risk_limits.json`.
