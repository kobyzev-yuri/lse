# План учёта премаркета (с учётом мыслей Алекса)

**Реализовано:**
- **Этап 1:** модуль `services/premarket.py`, `minutes_until_open` в `market_session`, вызов премаркета в `recommend_5m` при PRE_MARKET; цена в ответе в премаркете = `premarket_last`.
- **Этап 2.2–2.3:** при PRE_MARKET в вывод добавлены `premarket_entry_recommendation` (войти сейчас / ждать 9:30 ET / лимит ниже) и `premarket_suggested_limit_price` (при гэпе вниз или тренде вниз).
- **Этап 4.1:** в выводе поля `estimated_upside_pct_day` (эффективный тейк % от импульса 2ч) и `suggested_take_profit_price`.
- **Этап 4.2:** в выводе `entry_advice` (ALLOW / CAUTION / AVOID) и `entry_advice_reason` (негатив в новостях, волатильность, премаркет гэп вниз).

**Этап 3.1:** в AnalystAgent при PRE_MARKET в `technical_data` добавляется `premarket_note` (цена премаркета, гэп %, минуты до открытия); LLM-сервис вставляет этот блок в промпт. Дневные рекомендации с LLM учитывают премаркет.

**Этап 5.1:** скрипт `scripts/premarket_cron.py` — поллинг премаркета по TICKERS_FAST (+ тикерам портфельной игры), лог в `logs/premarket_cron.log`. При `PREMARKET_ALERT_TELEGRAM=true` — алерт в Telegram. В `setup_cron.sh` задача включена: **30 16 * * 1-5** (16:30 MSK пн–пт).

**Сниппеты для проверки:** [docs/SNIPPETS_PREMARKET_CHECK.md](SNIPPETS_PREMARKET_CHECK.md).

## Цели (из требований Алекса)

1. **Входить по текущему курсу или не входить?** — чёткий сигнал да/нет.
2. **Определять курс входа по времени претрейдинга** — цена может «утечь» в премаркете; к открытию US можно войти выгоднее.
3. **Понять, что цена идёт вниз → лимит входа** — не рыночный вход, а лимитный ордер.
4. **Оценка апсайда на день → выставить close-ордер** — целевой уровень на день.
5. **Tips, когда входить слишком рискованно** — явный «запрет входа».
6. **Бот должен смотреть на премаркет** — сейчас оценивается только регулярная сессия; премаркет торгуется, даёт импульс к открытию.

---

## Текущее состояние

- **market_session.py**: фаза `PRE_MARKET` определяется (до 9:30 ET), но **данные премаркета не запрашиваются**.
- **Цена для решений**: берётся последний **close из регулярной сессии** (`quotes` или 5m last close). Премаркет не используется.
- **Вход**: в премаркете вход отложен («ждём открытия биржи 9:30 ET»), ликвидность не оценивается.
- **yfinance**: поддерживает `prepost=True` в `history()` — даёт премаркет/постмаркет (ограничение: 1m только за последние ~7 дней).

---

## План по этапам

### Этап 1. Данные премаркета (общий слой)

**Цель:** иметь по тикеру «последний close регулярной сессии» и «текущую цену премаркета / гэп».

| Задача | Описание |
|--------|----------|
| 1.1 | **Сервис премаркета** — новый модуль `services/premarket.py`: функция `get_premarket_context(ticker)` (или по списку тикеров). Внутри: при `session_phase == "PRE_MARKET"` запрос к yfinance с `prepost=True`, интервал 1m (или 5m если доступно), период 1d; из ответа взять последнюю цену (close/last) и объём за текущий премаркет. Предыдущий regular close взять из `quotes` (последний date до сегодня) или из того же history. Вернуть: `prev_close`, `premarket_last`, `premarket_gap_pct`, `premarket_volume`, `minutes_until_open` (до 9:30 ET). |
| 1.2 | **Кэш/лимиты** | Не дергать yfinance на каждый запрос: кэш на 1–2 минуты по тикеру или общий вызов раз в N минут в кроне. Учесть лимиты Yahoo (1m — обычно 7 дней). |
| 1.3 | **Расширение market_session** | В `get_market_session_context()` добавить опционально (или отдельной функцией) поля: `minutes_until_open`, `minutes_since_premarket_start` (премаркет NYSE часто с 4:00 ET). Не хранить там цену — только время. |

**Результат этапа:** любой модуль может запросить «премаркет-контекст» по тикеру (гэп к закрытию, последняя цена премаркета, минуты до открытия).

---

### Этап 2. Использование в стратегиях 5m (GAME_5m)

**Цель:** при премаркете не просто «вход отложен», а «решение с учётом премаркета: войти по текущему курсу или ждать открытия / лимит».

| Задача | Описание |
|--------|----------|
| 2.1 | **recommend_5m** | В `get_decision_5m()` при `session_phase == "PRE_MARKET"` опционально вызывать `get_premarket_context(ticker)`. В выходной dict добавить поля: `premarket_last`, `premarket_gap_pct`, `minutes_until_open`. В `reasoning` добавить фразу вида: «Премаркет: последняя цена X, гэп к закрытию Y%». Не менять логику BUY/HOLD/SELL по правилам RSI/импульса — только обогатить контекст. |
| 2.2 | **Сигнал «вход по премаркету vs ждать открытия»** | На основе гэпа и правил (или позже LLM): если гэп сильно отрицательный и ликвидность низкая — явно писать «Рекомендация: войти после открытия 9:30 ET или лимит ниже X». Если гэп близок к нулю/положительный — «Можно рассмотреть вход по текущей цене премаркета (ликвидность ниже обычной)». |
| 2.3 | **Лимит входа при движении вниз** | Если по 5m/премаркету тренд вниз (например импульс 2ч отрицательный и гэп отрицательный) — в вывод добавить рекомендацию «Вход лимитом ниже текущей цены» и опционально уровень (например prev_close − 0.5%). |

**Результат этапа:** 5m-решение в премаркете содержит данные премаркета и текстовую подсказку: войти сейчас / ждать открытия / лимит.

---

### Этап 3. Портфельная игра и дневные стратегии (AnalystAgent)

**Цель:** дневные решения тоже видят премаркет; LLM получает гэп и «минуты до открытия» для советов.

| Задача | Описание |
|--------|----------|
| 3.1 | **Контекст для LLM** | В запросе к LLM (analyst_agent или аналог) при `session_phase == "PRE_MARKET"` добавлять блок: предыдущий close, последняя цена премаркета, гэп %, минуты до открытия. Формулировка: «Сейчас премаркет. До открытия US N мин. Цена премаркета X, гэп к вчерашнему закрытию Y%. Учти это при рекомендации входа.» |
| 3.2 | **Цена для расчёта размера позиции** | В execution_agent при премаркете можно оставить «не входить» (как сейчас) или использовать для расчёта размеров цену премаркета (опционально по конфигу). План: сначала только контекст для LLM; вход в позицию по-прежнему только в регулярной сессии, если не примем иное решение. |

**Результат этапа:** дневные рекомендации и LLM учитывают премаркет; решение «входить по текущему курсу или нет» может опираться на гэп и время до открытия.

---

### Этап 4. Оценка апсайда на день и «запрет входа»

**Цель:** явная оценка целевого уровня на день (для close-ордера) и явный сигнал «вход запрещён / рискованно».

| Задача | Описание |
|--------|----------|
| 4.1 | **Оценка апсайда на день** | В 5m: уже есть «тейк» от импульса 2ч или фикс %. Оформить в выводе как явное поле `estimated_upside_pct_day` или `suggested_take_profit_price` (опционально от премаркета/хая сессии). В дневных стратегиях: запрашивать у LLM или по правилам «оценка разумного апсайда на день в %» и возвращать в ответе. |
| 4.2 | **Запрет входа (tips)** | Ввести в ответ агента явный флаг/тип: `entry_advice: "ALLOW" | "CAUTION" | "AVOID"` и короткий текст `entry_advice_reason`. Срабатывает при: сильном негативе в новостях, экстремальной волатильности, премаркет с большим гэпом вниз при негативе и т.д. Отображать в Telegram/веб: «Вход не рекомендован: …». |

**Результат этапа:** в выводе есть целевой уровень на день и явная рекомендация «входить / осторожно / не входить» с причиной.

---

### Этап 5. Крон и расписание

| Задача | Описание |
|--------|----------|
| 5.1 | **Премаркет-поллинг** | Опциональный крон за 30–60 мин до открытия US (например 8:00 ET пн–пт): запуск скрипта, который по TICKERS_FAST (и/или тикерам портфельной игры) запрашивает премаркет-контекст, обновляет кэш или сохраняет в БД/файл, и при необходимости отправляет алерт «Премаркет: тикер X, гэп Y%, до открытия N мин» (если включено в конфиге). |
| 5.2 | **Не дергать 5m в премаркете лишний раз** | Сейчас при PRE_MARKET крон 5m выходит рано (без 5m-запросов). Можно оставить так; премаркет-данные тогда запрашиваются только в отдельном премаркет-кроне или при ручном запросе (Telegram / веб). Либо разрешить один лёгкий запуск 5m за N минут до открытия только для тикеров с премаркет-контекстом — по желанию. |

**Результат этапа:** предсказуемое расписание сбора премаркета и отсутствие лишней нагрузки от 5m в премаркете.

---

## Зависимости и порядок

- **Сначала:** Этап 1 (данные премаркета).
- **Потом:** Этапы 2 и 3 можно делать параллельно (2 — 5m, 3 — дневные/LLM).
- **Затем:** Этап 4 (апсайд на день, запрет входа).
- **В конце:** Этап 5 (крон/расписание).

## Риски и ограничения

- **yfinance 1m + prepost:** ограничение по глубине истории (обычно 7 дней); для «сегодняшний премаркет» достаточно.
- **Ликвидность:** в премаркете она ниже — в текстах и советах это явно указывать (как и заметил Алекс).
- **Гэп и импульс:** «цена чуть ниже закрытия» в премаркете может добавлять импульс к открытию — это как раз то, что нужно передавать в модель и в подсказки (гэп %, минуты до открытия).

## См. также

- [market_session.py](../services/market_session.py) — фазы сессии.
- [recommend_5m.py](../services/recommend_5m.py) — решение 5m.
- [GAME_SNDK.md](GAME_SNDK.md) — игра 5m.
- Мысли Алекса (24–25.02.2026): вход по тек. курсу, курс входа по претрейдингу, лимит при движении вниз, апсайд на день, запрет входа; учёт премаркета.
