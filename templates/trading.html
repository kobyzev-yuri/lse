{% extends "base.html" %}

{% block title %}–¢–æ—Ä–≥–æ–≤–ª—è - LSE Trading System{% endblock %}

{% block content %}
<h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π</h1>

<div class="card">
    <h2>–ê–Ω–∞–ª–∏–∑ —Ç–∏–∫–µ—Ä–∞</h2>
    <form id="analyzeForm">
        <label>–¢–∏–∫–µ—Ä:</label>
        <select name="ticker" id="tickerSelect" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–∫–µ—Ä</option>
            {% for ticker in tickers %}
            <option value="{{ ticker }}">{{ ticker }}</option>
            {% endfor %}
        </select>
        
        <label>
            <input type="checkbox" name="use_llm" id="useLLM" checked> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM –∞–Ω–∞–ª–∏–∑
        </label>
        
        <button type="submit">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
    </form>
    
    <div id="analysisResult" style="margin-top: 2rem;"></div>
</div>

<div class="card">
    <h2>–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫</h2>
    <form id="executeForm">
        <label>–¢–∏–∫–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
        <input type="text" name="tickers" id="tickersInput" placeholder="MSFT, SNDK" required>
        
        <button type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª</button>
    </form>
    
    <div id="executeResult" style="margin-top: 2rem;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('analyzeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('analysisResult');
    resultDiv.innerHTML = '<div class="loading">–ê–Ω–∞–ª–∏–∑...</div>';
    
    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        let html = '<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>';
        html += `<p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> ${data.decision}</p>`;
        html += `<p><strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–∏–≥–Ω–∞–ª:</strong> ${data.technical_signal}</p>`;
        html += `<p><strong>Sentiment:</strong> ${data.sentiment?.toFixed(3) || 'N/A'}</p>`;
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
        if (data.selected_strategy) {
            html += '<h4>üìã –í—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:</h4>';
            html += `<p><strong>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> <span style="color: #3498db; font-weight: bold;">${data.selected_strategy}</span></p>`;
            
            if (data.strategy_result) {
                const strategy = data.strategy_result;
                html += `<p><strong>–°–∏–≥–Ω–∞–ª —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:</strong> ${strategy.signal || 'N/A'}</p>`;
                html += `<p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${((strategy.confidence || 0) * 100).toFixed(1)}%</p>`;
                html += `<p><strong>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${strategy.reasoning || 'N/A'}</p>`;
                
                if (strategy.stop_loss) {
                    html += `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å:</strong> ${parseFloat(strategy.stop_loss).toFixed(2)}%</p>`;
                }
                if (strategy.take_profit) {
                    html += `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç:</strong> ${parseFloat(strategy.take_profit).toFixed(2)}%</p>`;
                }
                if (strategy.entry_price) {
                    html += `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞:</strong> $${parseFloat(strategy.entry_price).toFixed(2)}</p>`;
                }
            }
        }
        
        // LLM Guidance (—Å—Ç—Ä–∞—Ç–µ–≥–∏—è)
        if (data.llm_guidance) {
            html += '<h4>ü§ñ LLM –°—Ç—Ä–∞—Ç–µ–≥–∏—è:</h4>';
            html += `<p><strong>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> <span style="color: #3498db; font-weight: bold;">${data.llm_guidance.strategy}</span></p>`;
            html += `<p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${(data.llm_guidance.confidence * 100).toFixed(1)}%</p>`;
            html += `<p><strong>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${data.llm_guidance.reasoning}</p>`;
            
            if (data.llm_guidance.entry_price) {
                html += `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞:</strong> $${parseFloat(data.llm_guidance.entry_price).toFixed(2)}</p>`;
            }
            if (data.llm_guidance.stop_loss) {
                html += `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å:</strong> ${parseFloat(data.llm_guidance.stop_loss).toFixed(2)}%</p>`;
            }
            if (data.llm_guidance.take_profit) {
                html += `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç:</strong> ${parseFloat(data.llm_guidance.take_profit).toFixed(2)}%</p>`;
            }
        }
        
        // –î–µ—Ç–∞–ª—å–Ω—ã–π LLM –∞–Ω–∞–ª–∏–∑
        if (data.llm_analysis) {
            html += '<h4>üìà –î–µ—Ç–∞–ª—å–Ω—ã–π LLM –ê–Ω–∞–ª–∏–∑:</h4>';
            html += `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ${data.llm_analysis.decision}</p>`;
            html += `<p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${(data.llm_analysis.confidence * 100).toFixed(1)}%</p>`;
            html += `<p><strong>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${data.llm_analysis.reasoning}</p>`;
            
            if (data.llm_analysis.risks && data.llm_analysis.risks.length > 0) {
                html += `<p><strong>–†–∏—Å–∫–∏:</strong> ${data.llm_analysis.risks.join(', ')}</p>`;
            }
            if (data.llm_analysis.key_factors && data.llm_analysis.key_factors.length > 0) {
                html += `<p><strong>–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:</strong> ${data.llm_analysis.key_factors.join(', ')}</p>`;
            }
        }
        
        resultDiv.innerHTML = html;
    } catch (error) {
        resultDiv.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞: ${error.message}</div>`;
    }
});

document.getElementById('executeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('executeResult');
    resultDiv.innerHTML = '<div class="loading">–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ...</div>';
    
    try {
        const response = await fetch('/api/execute', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        resultDiv.innerHTML = `<div style="color: green;">${data.message}</div>`;
    } catch (error) {
        resultDiv.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞: ${error.message}</div>`;
    }
});
</script>
{% endblock %}

