{% extends "base.html" %}

{% block title %}Визуализация - LSE Trading System{% endblock %}

{% block content %}
<h1>Визуализация данных</h1>

<div class="card">
    <h2>График котировок (дневной)</h2>
    <label>Тикер:</label>
    <select id="tickerSelect">
        <option value="">Выберите тикер</option>
        {% for ticker in tickers %}
        <option value="{{ ticker }}">{{ ticker }}</option>
        {% endfor %}
    </select>
    
    <canvas id="quotesChart" style="max-height: 400px; margin-top: 1rem;"></canvas>
</div>

<div class="card">
    <h2>График 5m (интрадей + пролонгация)</h2>
    <p style="color:#666; font-size:0.9rem; margin-bottom:0.5rem;">Те же функции, что в Telegram: зона прогноза, аппроксимация EMA, тренд при ≥5 свечах. Ось времени — US Eastern (NYSE/NASDAQ).</p>
    <label>Тикер:</label>
    <select id="ticker5mSelect">
        <option value="">Выберите тикер</option>
        {% for ticker in (tickers_5m or tickers or ['SNDK']) %}
        <option value="{{ ticker }}" {% if ticker == 'SNDK' %}selected{% endif %}>{{ ticker }}</option>
        {% endfor %}
    </select>
    <label style="margin-left:1rem;">Дней:</label>
    <select id="days5mSelect">
        <option value="1">1</option>
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="7">7</option>
    </select>
    <canvas id="chart5m" style="max-height: 400px; margin-top: 1rem;"></canvas>
    <div id="chart5mLegend" style="margin-top:0.5rem; font-size:0.85rem; color:#666;"></div>
</div>

<div class="card">
    <h2>PnL по сделкам</h2>
    <canvas id="pnlChart" style="max-height: 400px;"></canvas>
</div>
{% endblock %}

{% block extra_js %}
<script>
let quotesChart = null;
let pnlChart = null;
let chart5m = null;

function formatChart5mTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', timeZone: 'America/New_York' });
}

async function loadChart5m() {
    const ticker = document.getElementById('ticker5mSelect').value;
    const days = parseInt(document.getElementById('days5mSelect').value, 10);
    if (!ticker) {
        if (chart5m) { chart5m.destroy(); chart5m = null; }
        document.getElementById('chart5mLegend').textContent = '';
        return;
    }
    try {
        const response = await fetch(`/api/chart5m/${encodeURIComponent(ticker)}?days=${days}`);
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
            const msg = (data.detail || response.statusText || 'Нет 5m данных');
            throw new Error(typeof msg === 'string' ? msg : JSON.stringify(msg));
        }
        const labels = data.times.concat(data.prolongation.times);
        const nMain = data.times.length;
        const nProlong = data.prolongation.times.length;
        const closeData = data.close.concat(Array(nProlong).fill(null));
        const prolongData = Array(nMain).fill(null).concat(data.prolongation.prices);

        const datasets = [
            {
                label: 'Close',
                data: closeData,
                borderColor: '#1565c0',
                backgroundColor: 'rgba(21, 101, 192, 0.05)',
                fill: false,
                tension: 0.1,
                pointRadius: 0,
                borderWidth: 1.2
            },
            {
                label: data.prolongation.label || (data.prolongation.forecast_defined ? 'Прогноз' : '… прогноз не определён'),
                data: prolongData,
                borderColor: '#c62828',
                borderDash: data.prolongation.forecast_defined ? [] : [4, 4],
                borderWidth: data.prolongation.forecast_defined ? 1.2 : 0.8,
                fill: false,
                tension: 0,
                pointRadius: 0
            }
        ];
        if (data.entry_price != null) {
            datasets.push({
                label: 'Вход @ ' + data.entry_price.toFixed(2),
                data: labels.map(() => data.entry_price),
                borderColor: '#2e7d32',
                borderDash: [6, 4],
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });
        }
        if (data.session_high != null) {
            datasets.push({
                label: 'Хай сессии ' + data.session_high.toFixed(2),
                data: labels.map(() => data.session_high),
                borderColor: '#f57c00',
                borderDash: [2, 4],
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });
        }
        if (data.take_level != null) {
            datasets.push({
                label: 'Тейк ' + data.take_level.toFixed(2),
                data: labels.map(() => data.take_level),
                borderColor: '#2e7d32',
                borderDash: [2, 2],
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });
        }

        // Отметки сделок: вход (BUY), тейк, стоп, прочий выход
        function findClosestLabelIndex(labels, ts) {
            const t = new Date(ts).getTime();
            let best = 0;
            let bestDiff = Infinity;
            labels.forEach((l, i) => {
                const d = Math.abs(new Date(l).getTime() - t);
                if (d < bestDiff) { bestDiff = d; best = i; }
            });
            return best;
        }
        function makeTradeDataset(trades, label, color, pointStyle) {
            const arr = labels.map(() => null);
            trades.forEach(tr => {
                const i = findClosestLabelIndex(labels, tr.ts);
                arr[i] = tr.price;
            });
            if (arr.every(v => v == null)) return null;
            return {
                label: label,
                data: arr,
                borderColor: color,
                backgroundColor: color,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointStyle: pointStyle,
                fill: false,
                tension: 0,
                borderWidth: 0
            };
        }
        const trades = data.trades || [];
        const buyTrades = trades.filter(t => t.side === 'BUY');
        const takeTrades = trades.filter(t => t.side === 'SELL' && (t.signal_type || '').toUpperCase() === 'TAKE_PROFIT');
        const stopTrades = trades.filter(t => t.side === 'SELL' && (t.signal_type || '').toUpperCase() === 'STOP_LOSS');
        const otherTrades = trades.filter(t => t.side === 'SELL' && (t.signal_type || '').toUpperCase() !== 'TAKE_PROFIT' && (t.signal_type || '').toUpperCase() !== 'STOP_LOSS');
        [buyTrades, takeTrades, stopTrades, otherTrades].forEach((arr, idx) => {
            const cfg = [
                { label: 'Вход (BUY)', color: '#2e7d32', pointStyle: 'triangle' },
                { label: 'Тейк', color: '#1b5e20', pointStyle: 'circle' },
                { label: 'Стоп', color: '#c62828', pointStyle: 'circle' },
                { label: 'Выход', color: '#757575', pointStyle: 'circle' }
            ][idx];
            const ds = makeTradeDataset(arr, cfg.label, cfg.color, cfg.pointStyle);
            if (ds) datasets.push(ds);
        });

        if (chart5m) chart5m.destroy();
        const ctx = document.getElementById('chart5m').getContext('2d');
        chart5m = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: { ticks: { maxTicksLimit: 14, callback: (v, i) => formatChart5mTime(labels[i]) } },
                    y: { title: { display: true, text: 'Цена' } }
                },
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });
        document.getElementById('chart5mLegend').textContent =
            data.prolongation.forecast_defined
                ? 'Пролонгация: ' + (data.prolongation.label || '')
                : 'Пролонгация: тренд не определён (нужно ≥5 свечей в одном направлении)';
    } catch (err) {
        if (chart5m) { chart5m.destroy(); chart5m = null; }
        document.getElementById('chart5mLegend').textContent = 'Ошибка: ' + (err.message || 'нет данных');
    }
}

document.getElementById('ticker5mSelect').addEventListener('change', loadChart5m);
document.getElementById('days5mSelect').addEventListener('change', loadChart5m);
// Автозагрузка графика 5m при открытии страницы (если выбран тикер)
if (document.getElementById('ticker5mSelect').value) {
    loadChart5m();
}

document.getElementById('tickerSelect').addEventListener('change', async (e) => {
    const ticker = e.target.value;
    if (!ticker) return;
    
    try {
        const response = await fetch(`/api/quotes/${ticker}?days=30`);
        const data = await response.json();
        
        const dates = data.data.map(d => d.date);
        const closes = data.data.map(d => d.close);
        const sma5 = data.data.map(d => d.sma_5);
        
        if (quotesChart) {
            quotesChart.destroy();
        }
        
        const ctx = document.getElementById('quotesChart').getContext('2d');
        quotesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Цена закрытия',
                    data: closes,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }, {
                    label: 'SMA 5',
                    data: sma5,
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });
    } catch (error) {
        console.error('Ошибка загрузки данных:', error);
    }
});

// Загрузка PnL данных
(async () => {
    try {
        const response = await fetch('/api/pnl');
        const data = await response.json();
        
        const trades = data.pnl;
        const labels = trades.map(t => t.ts);
        const pnl = trades.map(t => t.net_pnl);
        
        const ctx = document.getElementById('pnlChart').getContext('2d');
        pnlChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'PnL',
                    data: pnl,
                    backgroundColor: pnl.map(p => p >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)')
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });
    } catch (error) {
        console.error('Ошибка загрузки PnL:', error);
    }
})();
</script>
{% endblock %}



