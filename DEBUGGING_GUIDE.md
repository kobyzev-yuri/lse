# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–ª–∞–¥–∫–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–∏—Å—Ç–µ–º—ã

## –ü–æ—Å–ª–µ –ø—Ä–æ–≥–æ–Ω–∞ –≤ Cursor: –ù–∞ —á—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å

### 1. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (The Switch)

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ `analyst_agent.py`. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–ø–∏—Å–∏ –≤—Ä–æ–¥–µ:

```
üîÑ Volatility is high (1.8x), Sentiment is Extreme (0.85) -> Switching to VolatileGapStrategy for SNDK
üîÑ Market is calm (0.7x), Positive sentiment (0.6) -> Using MomentumStrategy for MSFT
üîÑ Market is volatile (1.5x), Neutral sentiment (0.1) -> Using MeanReversionStrategy for AAPL
```

**–ï—Å–ª–∏ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä–æ–≥–∏ (thresholds) –≤ `strategy_manager.py`
- –í–æ–∑–º–æ–∂–Ω–æ, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –±—É–º–∞–≥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–¥–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
- –ü–æ–¥—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä–æ–≥–∏ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±—É–º–∞–≥–∏:
  ```python
  self.high_volatility_threshold = 1.5  # –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 1.2 –¥–ª—è –±–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  self.extreme_sentiment_threshold = 0.6  # –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 0.5
  ```

### 2. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ Sentiment

–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ LLM-—Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```
‚úÖ Sentiment —Ä–∞—Å—Å—á–∏—Ç–∞–Ω —á–µ—Ä–µ–∑ LLM: 0.850
   –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π sentiment (-1.0 –¥–æ 1.0): 0.700
```

**–ï—Å–ª–∏ "–ø–æ–∑–∏—Ç–∏–≤" (0.8) –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ "–Ω–µ–π—Ç—Ä–∞–ª":**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `normalize_sentiment()` –≤ `utils/sentiment_utils.py`
- –§–æ—Ä–º—É–ª–∞: `(sentiment - 0.5) * 2`
- 0.8 -> (0.8 - 0.5) * 2 = 0.6 (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –Ω–µ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π)
- –î–ª—è —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–≥–æ sentiment –Ω—É–∂–Ω–æ > 0.75 –≤ –±–∞–∑–æ–≤–æ–π —à–∫–∞–ª–µ (-> 0.5 –≤ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:**
```python
from utils.sentiment_utils import normalize_sentiment, denormalize_sentiment

# –¢–µ—Å—Ç
assert normalize_sentiment(0.0) == -1.0
assert normalize_sentiment(0.5) == 0.0
assert normalize_sentiment(1.0) == 1.0
assert denormalize_sentiment(-1.0) == 0.0
assert denormalize_sentiment(0.0) == 0.5
assert denormalize_sentiment(1.0) == 1.0
```

### 3. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (Execution)

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ExecutionAgent –Ω–µ –Ω–∞—á–∞–ª "—Å–ø–∞–º–∏—Ç—å" —Å–¥–µ–ª–∫–∞–º–∏. –ü—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Ä–∏—Å–∫ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π (Whipsaw).

**–ü—Ä–∏–∑–Ω–∞–∫–∏ Whipsaw:**
- –ë–æ–ª–µ–µ 3-5 —Å–¥–µ–ª–æ–∫ –≤ –¥–µ–Ω—å –ø–æ –æ–¥–Ω–æ–º—É —Ç–∏–∫–µ—Ä—É
- –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ BUY –∏ SELL —Å–∏–≥–Ω–∞–ª–æ–≤
- –ù–∏–∑–∫–∏–π –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π PnL –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é —Ç–æ—Ä–≥–æ–≤–ª—é

**–ó–∞—â–∏—Ç–∞ –æ—Ç Whipsaw:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–¥–µ–ª–∫–∞–º–∏ (cooldown period) - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ `execution_agent.py`
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ª–∞–±—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ STRONG_BUY/STRONG_SELL)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–∞—Å—Ç–æ—Ç—ã —Å–¥–µ–ª–æ–∫

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å—Ç–æ—Ç—ã —Å–¥–µ–ª–æ–∫ –ø–æ —Ç–∏–∫–µ—Ä—É
SELECT ticker, COUNT(*) as trade_count, 
       MIN(ts) as first_trade, MAX(ts) as last_trade
FROM trade_history
WHERE ts >= CURRENT_DATE
GROUP BY ticker
HAVING COUNT(*) > 5  -- –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –º–Ω–æ–≥–æ —Å–¥–µ–ª–æ–∫
ORDER BY trade_count DESC;
```

### 4. –ó–∞–ø–∏—Å—å strategy_name –≤ trade_history

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ExecutionAgent –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `strategy_name` –≤ —Ç–∞–±–ª–∏—Ü—É `trade_history`:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π strategy_name
SELECT ticker, side, signal_type, strategy_name, ts
FROM trade_history
ORDER BY ts DESC
LIMIT 20;
```

**–ï—Å–ª–∏ strategy_name = NULL:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `result.get('selected_strategy')` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `execution_agent.py`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `AnalystAgent` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `selected_strategy` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª–µ `strategy_name` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É (—Å–º. `init_db.py`)

### 5. –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

–ü–æ—Å–ª–µ –ø—Ä–æ–≥–æ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏–Ω–µ—Å–ª–∞ –±–æ–ª—å—à–µ –¥–µ–Ω–µ–≥:

```sql
-- PnL –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º
SELECT 
    strategy_name,
    COUNT(*) as trade_count,
    SUM(CASE WHEN side = 'BUY' THEN -total_value ELSE total_value END) as net_pnl,
    AVG(sentiment_at_trade) as avg_sentiment
FROM trade_history
WHERE strategy_name IS NOT NULL
GROUP BY strategy_name
ORDER BY net_pnl DESC;
```

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- MomentumStrategy: –±–æ–ª—å—à–µ —Å–¥–µ–ª–æ–∫, –≤—ã—à–µ —Å—Ä–µ–¥–Ω–∏–π sentiment
- MeanReversionStrategy: —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π sentiment
- VolatileGapStrategy: –º–µ–Ω—å—à–µ —Å–¥–µ–ª–æ–∫, –Ω–æ –≤—ã—à–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤
SELECT 
    ticker,
    COUNT(*) as stop_loss_count,
    AVG(sentiment_at_trade) as avg_sentiment,
    SUM(total_value) as total_loss
FROM trade_history
WHERE signal_type = 'STOP_LOSS'
GROUP BY ticker
ORDER BY stop_loss_count DESC;
```

**–ï—Å–ª–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Ä–æ–≤–µ–Ω—å `STOP_LOSS_LEVEL = 0.95` (5% –ø–∞–¥–µ–Ω–∏–µ)
- –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 0.97 (3% –ø–∞–¥–µ–Ω–∏–µ) –¥–ª—è –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 0.93 (7% –ø–∞–¥–µ–Ω–∏–µ) –¥–ª—è –±–æ–ª–µ–µ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

### 7. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è "–ó–∞–≤–æ–¥–∞ –°—Ç—Ä–∞—Ç–µ–≥–∏–π"

–¢–µ–ø–µ—Ä—å –≤–∞—à–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ö–µ–¥–∂-—Ñ–æ–Ω–¥–æ–≤:

```
AnalystAgent
    ‚Üì
StrategyManager (The Switch)
    ‚îú‚îÄ‚îÄ VolatileGapStrategy (–≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å + –≥—ç–ø)
    ‚îú‚îÄ‚îÄ MomentumStrategy (–Ω–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å + –ø–æ–∑–∏—Ç–∏–≤)
    ‚îî‚îÄ‚îÄ MeanReversionStrategy (–≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å + –Ω–µ–π—Ç—Ä–∞–ª)
    ‚Üì
ExecutionAgent
    ‚Üì
trade_history (—Å–æ strategy_name)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã "–ó–∞–≤–æ–¥–∞":**
1. –†–∞–∑–Ω—ã–µ —Ç–∏–∫–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
2. –û–¥–∏–Ω —Ç–∏–∫–µ—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π —Ä—ã–Ω–∫–∞
3. –í—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ `trade_history`

### 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ PnL (Profit and Loss)

–ü–æ—Å–ª–µ –ø—Ä–æ–≥–æ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–π PnL:

```sql
-- –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
SELECT 
    ticker,
    quantity as cash_or_shares,
    avg_entry_price
FROM portfolio_state
WHERE ticker = 'CASH' OR quantity > 0;

-- PnL –ø–æ —Å–¥–µ–ª–∫–∞–º
SELECT 
    ticker,
    side,
    SUM(CASE WHEN side = 'BUY' THEN -total_value ELSE total_value END) as pnl,
    COUNT(*) as trade_count
FROM trade_history
GROUP BY ticker, side
ORDER BY ticker, side;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π PnL (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π)
- –ó–∞–ø–∏—Å–∏ –≤ `trade_history` —Å–æ `strategy_name`
- –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É sentiment
3. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç Whipsaw
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø–∏—Å—å strategy_name
5. ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–π PnL

---

## –°–º. —Ç–∞–∫–∂–µ

- [Trading Glossary](docs/TRADING_GLOSSARY.md)
- [Strategy Manager Update](STRATEGY_MANAGER_AND_SENTIMENT_UPDATE.md)

